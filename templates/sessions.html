{% extends "base.html" %}

{% block title %}مدیریت جلسات - Orcest AI{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>مدیریت جلسات فعال</h2>
        <p class="text-muted">مشاهده و مدیریت تمام جلسات فعال کاربران</p>
    </div>
</div>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h4>جلسات فعال ({{ sessions|length }} جلسه)</h4>
        <button onclick="refreshSessions()" class="btn btn-secondary btn-sm">بروزرسانی</button>
    </div>
    <div class="card-body">
        {% if sessions %}
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>کاربر</th>
                        <th>دستگاه</th>
                        <th>آدرس IP</th>
                        <th>مکان</th>
                        <th>ایجاد شده</th>
                        <th>آخرین فعالیت</th>
                        <th>مدت زمان</th>
                        <th>عملیات</th>
                    </tr>
                </thead>
                <tbody>
                    {% for session in sessions %}
                    <tr>
                        <td>
                            <strong>{{ session.user.name }}</strong><br>
                            <small class="text-muted">{{ session.user.email }}</small><br>
                            <span class="badge badge-{{ session.user.role }}">{{ session.user.role }}</span>
                        </td>
                        <td>
                            <strong>{{ session.device_info or 'نامشخص' }}</strong>
                            {% if session.user_agent %}
                            <br><small class="text-muted">{{ session.user_agent[:50] }}{% if session.user_agent|length > 50 %}...{% endif %}</small>
                            {% endif %}
                        </td>
                        <td>{{ session.ip_address or 'نامشخص' }}</td>
                        <td>{{ session.location or 'نامشخص' }}</td>
                        <td>{{ session.created_at.strftime('%Y/%m/%d %H:%M') }}</td>
                        <td>{{ session.last_activity.strftime('%Y/%m/%d %H:%M') if session.last_activity else 'نامشخص' }}</td>
                        <td>
                            {% set duration = (session.last_activity or session.created_at) - session.created_at %}
                            {% if duration.days > 0 %}
                            {{ duration.days }} روز
                            {% elif duration.seconds > 3600 %}
                            {{ (duration.seconds // 3600) }} ساعت
                            {% else %}
                            {{ (duration.seconds // 60) }} دقیقه
                            {% endif %}
                        </td>
                        <td>
                            <form method="post" action="/admin/sessions/{{ session.id }}/revoke" style="display: inline;">
                                <button type="submit" class="btn btn-danger btn-sm" 
                                        onclick="return confirm('آیا مطمئن هستید که می‌خواهید این جلسه را لغو کنید؟')">
                                    لغو جلسه
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="mt-3">
            <div class="alert alert-info">
                <strong>نکته:</strong> جلسات منقضی شده به‌طور خودکار پاک می‌شوند. جلسات فعال حداکثر 24 ساعت اعتبار دارند.
            </div>
        </div>
        {% else %}
        <div class="alert alert-info">
            هیچ جلسه فعالی یافت نشد.
        </div>
        {% endif %}
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h4>آمار جلسات</h4>
    </div>
    <div class="card-body">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">{{ sessions|length }}</div>
                <div class="stat-label">جلسات فعال</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ sessions|selectattr('user.role', 'equalto', 'admin')|list|length }}</div>
                <div class="stat-label">جلسات مدیر</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ sessions|map(attribute='user.id')|unique|list|length }}</div>
                <div class="stat-label">کاربران منحصربه‌فرد</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ sessions|map(attribute='ip_address')|unique|list|length }}</div>
                <div class="stat-label">IP های منحصربه‌فرد</div>
            </div>
        </div>
    </div>
</div>

<script>
function refreshSessions() {
    window.location.reload();
}

// Auto-refresh every 30 seconds
setInterval(refreshSessions, 30000);
</script>
{% endblock %}