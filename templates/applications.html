{% extends "base.html" %}

{% block title %}مدیریت اپلیکیشن‌ها - Orcest AI{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>مدیریت اپلیکیشن‌های OIDC</h2>
        <p class="text-muted">مدیریت کلاینت‌های OIDC و تنظیمات احراز هویت</p>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h4>کلاینت‌های OIDC ({{ clients|length }} کلاینت)</h4>
    </div>
    <div class="card-body">
        {% if clients %}
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>نام سرویس</th>
                        <th>Client ID</th>
                        <th>Client Secret</th>
                        <th>Redirect URIs</th>
                        <th>وضعیت</th>
                        <th>تاریخ ایجاد</th>
                        <th>عملیات</th>
                    </tr>
                </thead>
                <tbody>
                    {% for client in clients %}
                    <tr>
                        <td>
                            <strong>{{ client.service_name }}</strong><br>
                            <small class="text-muted">{{ client.client_id }}</small>
                        </td>
                        <td>
                            <code>{{ client.client_id }}</code>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <code id="secret-{{ client.id }}" style="display: none;">{{ client.client_secret }}</code>
                                <code id="hidden-{{ client.id }}">••••••••••••••••</code>
                                <button onclick="toggleSecret('{{ client.id }}')" class="btn btn-sm btn-secondary" style="margin-right: 10px;">
                                    نمایش
                                </button>
                            </div>
                        </td>
                        <td>
                            {% set redirect_uris = client.redirect_uris|from_json %}
                            {% for uri in redirect_uris %}
                            <div><small><code>{{ uri }}</code></small></div>
                            {% endfor %}
                        </td>
                        <td>
                            {% if client.is_active %}
                            <span class="badge badge-success">فعال</span>
                            {% else %}
                            <span class="badge badge-danger">غیرفعال</span>
                            {% endif %}
                        </td>
                        <td>{{ client.created_at.strftime('%Y/%m/%d') if client.created_at else 'نامشخص' }}</td>
                        <td>
                            <div class="d-flex" style="gap: 5px;">
                                <button onclick="editClient('{{ client.id }}')" class="btn btn-sm btn-secondary">ویرایش</button>
                                <button onclick="regenerateSecret('{{ client.id }}')" class="btn btn-sm btn-warning">تولید Secret جدید</button>
                                {% if client.is_active %}
                                <button onclick="toggleClientStatus('{{ client.id }}', false)" class="btn btn-sm btn-danger">غیرفعال</button>
                                {% else %}
                                <button onclick="toggleClientStatus('{{ client.id }}', true)" class="btn btn-sm btn-success">فعال</button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info">
            هیچ کلاینت OIDC یافت نشد.
        </div>
        {% endif %}
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h4>تنظیمات OIDC</h4>
    </div>
    <div class="card-body">
        <div class="row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
            <div>
                <h5>Endpoint های OIDC</h5>
                <div class="form-group">
                    <label>Discovery Endpoint:</label>
                    <div class="d-flex align-items-center">
                        <code>/.well-known/openid-configuration</code>
                        <button onclick="copyToClipboard('/.well-known/openid-configuration')" class="btn btn-sm btn-secondary" style="margin-right: 10px;">کپی</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Authorization Endpoint:</label>
                    <div class="d-flex align-items-center">
                        <code>/oauth2/authorize</code>
                        <button onclick="copyToClipboard('/oauth2/authorize')" class="btn btn-sm btn-secondary" style="margin-right: 10px;">کپی</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Token Endpoint:</label>
                    <div class="d-flex align-items-center">
                        <code>/oauth2/token</code>
                        <button onclick="copyToClipboard('/oauth2/token')" class="btn btn-sm btn-secondary" style="margin-right: 10px;">کپی</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>UserInfo Endpoint:</label>
                    <div class="d-flex align-items-center">
                        <code>/oauth2/userinfo</code>
                        <button onclick="copyToClipboard('/oauth2/userinfo')" class="btn btn-sm btn-secondary" style="margin-right: 10px;">کپی</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>JWKS Endpoint:</label>
                    <div class="d-flex align-items-center">
                        <code>/oauth2/jwks</code>
                        <button onclick="copyToClipboard('/oauth2/jwks')" class="btn btn-sm btn-secondary" style="margin-right: 10px;">کپی</button>
                    </div>
                </div>
            </div>
            
            <div>
                <h5>پیکربندی کلاینت</h5>
                <div class="alert alert-info">
                    <strong>نحوه پیکربندی:</strong><br>
                    1. Client ID و Client Secret را از جدول بالا کپی کنید<br>
                    2. Redirect URI را در سرویس هدف تنظیم کنید<br>
                    3. Issuer URL را به <code>https://login.orcest.ai</code> تنظیم کنید<br>
                    4. Scope را به <code>openid profile email</code> تنظیم کنید
                </div>
                
                <div class="form-group">
                    <label>متغیرهای محیطی مورد نیاز:</label>
                    <pre style="background: #f8f9fa; padding: 15px; border-radius: 4px; font-size: 12px;">
SSO_ISSUER=https://login.orcest.ai
SSO_CLIENT_ID=your_client_id
SSO_CLIENT_SECRET=your_client_secret
SSO_CALLBACK_URL=your_callback_url</pre>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function toggleSecret(clientId) {
    const secretElement = document.getElementById('secret-' + clientId);
    const hiddenElement = document.getElementById('hidden-' + clientId);
    const button = event.target;
    
    if (secretElement.style.display === 'none') {
        secretElement.style.display = 'inline';
        hiddenElement.style.display = 'none';
        button.textContent = 'مخفی';
    } else {
        secretElement.style.display = 'none';
        hiddenElement.style.display = 'inline';
        button.textContent = 'نمایش';
    }
}

function copyToClipboard(text) {
    const fullUrl = window.location.origin + text;
    navigator.clipboard.writeText(fullUrl).then(() => {
        alert('کپی شد: ' + fullUrl);
    });
}

function editClient(clientId) {
    // TODO: Implement client editing
    alert('ویرایش کلاینت: ' + clientId);
}

function regenerateSecret(clientId) {
    if (confirm('آیا مطمئن هستید؟ Client Secret جدید تولید شود؟ این عمل غیرقابل بازگشت است.')) {
        // TODO: Implement secret regeneration
        alert('Client Secret جدید تولید شد: ' + clientId);
    }
}

function toggleClientStatus(clientId, activate) {
    const action = activate ? 'فعال' : 'غیرفعال';
    if (confirm(`آیا مطمئن هستید که می‌خواهید این کلاینت را ${action} کنید؟`)) {
        // TODO: Implement client status toggle
        alert(`کلاینت ${action} شد: ` + clientId);
    }
}
</script>
{% endblock %}